# Use Node.js 18 for building
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Copy all files (package.json should be included)
COPY . .

# Debug: Check if package.json exists
RUN echo "=== CHECKING FILES ===" && \
    ls -la && \
    if [ ! -f package.json ]; then \
        echo "âŒ package.json not found, listing all JSON files:" && \
        find . -name "*.json" -type f || echo "No JSON files found" && \
        exit 1; \
    else \
        echo "âœ… package.json found"; \
    fi

# Install dependencies
RUN npm install --no-audit --no-fund

# Copy source code
COPY . .

# Build the Angular app
RUN npm run build -- --configuration=production --output-path=dist/retail-analytics-ui

# Verify build
RUN if [ ! -f "dist/retail-analytics-ui/index.html" ]; then \
        echo "âŒ BUILD FAILED - No index.html found"; \
        exit 1; \
    else \
        echo "âœ… Build successful"; \
        ls -la dist/retail-analytics-ui/; \
    fi

# Install serve globally
RUN npm install -g serve

# Create startup script
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'PORT=${PORT:-3000}' >> /start.sh && \
    echo 'echo "ðŸš€ Starting Angular app on port $PORT"' >> /start.sh && \
    echo 'serve -s dist/retail-analytics-ui -l $PORT' >> /start.sh && \
    chmod +x /start.sh

# Expose port
EXPOSE $PORT

# Start the app
CMD ["/start.sh"]